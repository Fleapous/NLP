@page "/"
@using Blazored.LocalStorage
@using Color = MudBlazor.Color
@using Size = MudBlazor.Size
@inject MapService MapService
@inject LocationService LocationService
@inject ILocalStorageService LocalStorage
@inject IDialogService DialogService

<PageTitle>Accidents</PageTitle>

<div class="main-div relative" style="overflow: clip">
    <Map Top="0" Left="0" Bottom="0" Right="0"
         InitialPosition="@OriginalPosition" MinZoom="@MinZoom" MaxZoom="@MaxZoom"
         Loaded="@OnMapLoaded" Resized="@OnMapResized"
         ZoomEnded="@OnZoomEnded" MoveEnded="@OnMapMoveEnded" Moved="@OnMapMoved">
    </Map>
    @foreach (var group in DisplayGroups)
    {
        <MudFab Label="@($"{group.Accidents.Count}")" Class="absolute white-text" 
                Style="@(GetPositionString(group.Position) + ";background-color: var(--mud-palette-dark);")"
                OnClick="@(() => ShowPopup(group))"/>
    }
    <MudPaper Elevation="2" Class="absolute pa-3 rounded-xl frosted" Style="top: 25px; left: 25px;">
        <MudStack Spacing="4">
            <MudFab OnClick="@MapService.ZoomIn" Size="Size.Small" StartIcon="@Icons.Add" Color="Color.Dark"/>
            <MudFab OnClick="@MapService.ResetPosition" Size="Size.Small" StartIcon="@Icons.GpsFixed" Color="Color.Dark"/>
            <MudFab OnClick="@MapService.ZoomOut" Size="Size.Small" StartIcon="@Icons.Remove" Color="Color.Dark"/>
        </MudStack>
    </MudPaper>
    <MudPaper Elevation="2" Class="absolute py-4 px-6 rounded-xl justify-space-around frosted" Style="top: 25px; right: 25px; min-width: 30%; width: 30%; bottom: 25px"
              @onmouseenter="@AccidentTabHovered" @onmouseleave="@AccidentTabUnhovered">
        <MudStack Spacing="4" Style="width: 100%; height: 100%">
            <MudPaper Elevation="4" Class="rounded-xl px-2" Style="background-color: var(--mud-palette-dark)">
                <MudText Typo="Typo.h3" Align="Align.Center" Class="playfair-display-regular pa-4" Style="color: white">
                    Accidents
                </MudText>
            </MudPaper>
            <MudSpacer/>
            <MudPaper Class="rounded-xl pa-4 flex-auto" Style="height: 66%; max-height: 66%;">
                <MudPaper Elevation="0" Class="pa-4 overflow-y-scroll d-flex flex-column" Style="height: 100%;">
                    @foreach (var accident in DisplayAccidents)
                    {
                        <AccidentItem Accident="@accident" OnMouseEnter="AccidentHovered"/>
                    }
                </MudPaper>
            </MudPaper>
            <MudSpacer/>
            <MudPaper Class="rounded-xl pa-4 flex-auto">
                <MudText>@Accidents.Count / @(Accidents.Count + NewAccidents.Count + LoadingOffset)</MudText>
            </MudPaper>
        </MudStack>
    </MudPaper>
</div>
